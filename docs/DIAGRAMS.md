# rust-p2p-usb Architecture Diagrams

Visual representations of the system architecture.

---

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        INTERNET / LAN                                 â”‚
â”‚          Iroh P2P Network with NAT Traversal (QUIC/TLS 1.3)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚                       â”‚
         â”â”â”â”â”â”â”â”â”â”â”â”â”â”â–¼â”â”â”â”â”â”â”â”â”â”â”â”â”“   â”â”â”â”â”â”â–¼â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
         â”ƒ   SERVER (Raspberry Pi)  â”ƒ   â”ƒ   CLIENT (Laptop)    â”ƒ
         â”ƒ                          â”ƒ   â”ƒ                      â”ƒ
         â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ   â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ
         â”ƒ  â”‚   Ratatui TUI      â”‚  â”ƒ   â”ƒ  â”‚  Ratatui TUI   â”‚  â”ƒ
         â”ƒ  â”‚ (Device Selection) â”‚  â”ƒ   â”ƒ  â”‚ (Device List)  â”‚  â”ƒ
         â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”ƒ   â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”ƒ
         â”ƒ            â”‚             â”ƒ   â”ƒ           â”‚          â”ƒ
         â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ   â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ
         â”ƒ  â”‚  Tokio Runtime     â”‚  â”ƒ   â”ƒ  â”‚ Tokio Runtime  â”‚  â”ƒ
         â”ƒ  â”‚  (async/await)     â”‚  â”ƒ   â”ƒ  â”‚ (async/await)  â”‚  â”ƒ
         â”ƒ  â”‚                    â”‚  â”ƒ   â”ƒ  â”‚                â”‚  â”ƒ
         â”ƒ  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”ƒ   â”ƒ  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”ƒ
         â”ƒ  â”‚  â”‚ Iroh Client â”‚â—„â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”¼â”€â–ºâ”‚Iroh Srv â”‚   â”‚  â”ƒ
         â”ƒ  â”‚  â”‚QUIC Endpointâ”‚   â”‚  â”ƒ   â”ƒ  â”‚ â”‚QUIC Endptâ”‚   â”‚  â”ƒ
         â”ƒ  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”ƒ   â”ƒ  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”ƒ
         â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”ƒ   â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”ƒ
         â”ƒ            â”‚             â”ƒ   â”ƒ           â”‚          â”ƒ
         â”ƒ    async_channel         â”ƒ   â”ƒ   async_channel      â”ƒ
         â”ƒ    (bounded: 256)        â”ƒ   â”ƒ   (bounded: 256)     â”ƒ
         â”ƒ            â”‚             â”ƒ   â”ƒ           â”‚          â”ƒ
         â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ   â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ
         â”ƒ  â”‚    USB Thread      â”‚  â”ƒ   â”ƒ  â”‚Virtual USB Th. â”‚  â”ƒ
         â”ƒ  â”‚libusb event loop   â”‚  â”ƒ   â”ƒ  â”‚ (usbfs/gadget) â”‚  â”ƒ
         â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”ƒ   â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”ƒ
         â”ƒ            â”‚             â”ƒ   â”ƒ           â”‚          â”ƒ
         â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ   â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ
         â”ƒ  â”‚  Physical USB      â”‚  â”ƒ   â”ƒ  â”‚ Virtual USB    â”‚  â”ƒ
         â”ƒ  â”‚  Devices (HW)      â”‚  â”ƒ   â”ƒ  â”‚ Devices (Kern) â”‚  â”ƒ
         â”ƒ  â”‚  ğŸ–±ï¸ âŒ¨ï¸ ğŸ–¨ï¸ ğŸ’¾        â”‚  â”ƒ   â”ƒ  â”‚ Exposed to OS  â”‚  â”ƒ
         â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”ƒ   â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”ƒ
         â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›   â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
```

---

## Runtime Architecture (Detailed)

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                     SERVER PROCESS                            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                               â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚         Tokio Multi-Threaded Runtime (Work-Stealing)   â”‚   â•‘
â•‘  â”‚                                                         â”‚   â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â•‘
â•‘  â”‚  â”‚ Main Taskâ”‚  â”‚TUI Task  â”‚  â”‚Net Task  â”‚  â”‚USB Br. â”‚ â”‚   â•‘
â•‘  â”‚  â”‚ (coord.) â”‚  â”‚(ratatui) â”‚  â”‚(accept)  â”‚  â”‚(recv)  â”‚ â”‚   â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚   â•‘
â•‘  â”‚       â”‚             â”‚              â”‚            â”‚      â”‚   â•‘
â•‘  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â•‘
â•‘  â”‚                          â”‚                             â”‚   â•‘
â•‘  â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚   â•‘
â•‘  â”‚                 â”‚  Per-Client Tasks â”‚                  â”‚   â•‘
â•‘  â”‚                 â”‚ (one per NodeId)  â”‚                  â”‚   â•‘
â•‘  â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚   â•‘
â•‘  â”‚                          â”‚                             â”‚   â•‘
â•‘  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚   â•‘
â•‘  â”‚              â”‚           â”‚           â”‚                 â”‚   â•‘
â•‘  â”‚       â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â•‘
â•‘  â”‚       â”‚Stream Task â”‚ â”‚Stream T. â”‚ â”‚USB Event T.â”‚      â”‚   â•‘
â•‘  â”‚       â”‚(control)   â”‚ â”‚(bulk)    â”‚ â”‚(listener)  â”‚      â”‚   â•‘
â•‘  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â•‘
â•‘  â”‚                                                         â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                            â”‚                                   â•‘
â•‘              async_channel::Sender<UsbCommand>                 â•‘
â•‘              async_channel::Receiver<UsbEvent>                 â•‘
â•‘                            â”‚                                   â•‘
â•‘  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â•‘
â•‘         CHANNEL BOUNDARY   â”‚   (capacity: 256)                 â•‘
â•‘  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â•‘
â•‘                            â”‚                                   â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚         USB Worker Thread (std::thread::spawn)         â”‚   â•‘
â•‘  â”‚         (single-threaded, dedicated, blocking)         â”‚   â•‘
â•‘  â”‚                                                         â”‚   â•‘
â•‘  â”‚  Main Loop:                                             â”‚   â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â•‘
â•‘  â”‚  â”‚ loop {                                           â”‚  â”‚   â•‘
â•‘  â”‚  â”‚   // Check for commands (non-blocking)          â”‚  â”‚   â•‘
â•‘  â”‚  â”‚   match cmd_rx.try_recv() {                     â”‚  â”‚   â•‘
â•‘  â”‚  â”‚     Ok(cmd) => handle_command(cmd),             â”‚  â”‚   â•‘
â•‘  â”‚  â”‚     Err(_) => {}                                â”‚  â”‚   â•‘
â•‘  â”‚  â”‚   }                                              â”‚  â”‚   â•‘
â•‘  â”‚  â”‚                                                  â”‚  â”‚   â•‘
â•‘  â”‚  â”‚   // Process USB events (100ms timeout)         â”‚  â”‚   â•‘
â•‘  â”‚  â”‚   context.handle_events(100ms);                 â”‚  â”‚   â•‘
â•‘  â”‚  â”‚                                                  â”‚  â”‚   â•‘
â•‘  â”‚  â”‚   // Hot-plug callbacks fire here               â”‚  â”‚   â•‘
â•‘  â”‚  â”‚   // Transfer completions fire here             â”‚  â”‚   â•‘
â•‘  â”‚  â”‚ }                                                â”‚  â”‚   â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â•‘
â•‘  â”‚                                                         â”‚   â•‘
â•‘  â”‚  async_channel::Receiver<UsbCommand>.recv_blocking()   â”‚   â•‘
â•‘  â”‚  async_channel::Sender<UsbEvent>.send_blocking()       â”‚   â•‘
â•‘  â”‚                                                         â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                            â”‚                                   â•‘
â•‘                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â•‘
â•‘                   â”‚ rusb (libusb FFI)â”‚                         â•‘
â•‘                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â•‘
â•‘                            â”‚                                   â•‘
â•‘                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â•‘
â•‘                   â”‚ Linux USB Stack  â”‚                         â•‘
â•‘                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â•‘
â•‘                            â”‚                                   â•‘
â•‘                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â•‘
â•‘                   â”‚ USB Hardware     â”‚                         â•‘
â•‘                   â”‚ ğŸ–±ï¸ âŒ¨ï¸ ğŸ–¨ï¸ ğŸ’¾      â”‚                         â•‘
â•‘                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## Protocol Message Flow

```
CLIENT                    NETWORK                    SERVER
  â”‚                         â”‚                          â”‚
  â”‚  1. ListDevicesRequest  â”‚                          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€QUIC Streamâ”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                         â”‚                          â”‚
  â”‚                         â”‚                          â”œâ”€â”
  â”‚                         â”‚                          â”‚ â”‚ Query USB
  â”‚                         â”‚                          â”‚ â”‚ subsystem
  â”‚                         â”‚                          â—„â”€â”˜
  â”‚                         â”‚                          â”‚
  â”‚ 2. ListDevicesResponse  â”‚                          â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€QUIC Streamâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚   [Device1, Device2]    â”‚                          â”‚
  â”‚                         â”‚                          â”‚
  â”‚                         â”‚                          â”‚
  â”‚ 3. AttachDeviceRequest  â”‚                          â”‚
  â”‚     (device_id: 1)      â”‚                          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€QUIC Streamâ”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                         â”‚                          â”‚
  â”‚                         â”‚                          â”œâ”€â”
  â”‚                         â”‚                          â”‚ â”‚ Open device
  â”‚                         â”‚                          â”‚ â”‚ Claim ifaces
  â”‚                         â”‚                          â—„â”€â”˜
  â”‚                         â”‚                          â”‚
  â”‚ 4. AttachDeviceResponse â”‚                          â”‚
  â”‚    (handle: 42)         â”‚                          â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€QUIC Streamâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                         â”‚                          â”‚
  â”‚                         â”‚                          â”‚
  â”‚  5. SubmitTransfer      â”‚                          â”‚
  â”‚     (control read)      â”‚                          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚â”€â”€â”€â”€â”€Control Streamâ”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                         â”‚                          â”‚
  â”‚                         â”‚                          â”œâ”€â”
  â”‚                         â”‚                          â”‚ â”‚ USB transfer
  â”‚                         â”‚                          â”‚ â”‚ (blocking)
  â”‚                         â”‚                          â—„â”€â”˜
  â”‚                         â”‚                          â”‚
  â”‚  6. TransferComplete    â”‚                          â”‚
  â”‚     (data: [0x12...])   â”‚                          â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€Control Streamâ”€â”€â”€â”€â”€â”€â”¤
  â”‚                         â”‚                          â”‚
  â”‚                         â”‚                          â”‚
  â”‚  7. SubmitTransfer      â”‚                          â”‚
  â”‚     (bulk write)        â”‚                          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚â”€â”€â”€â”€â”€â”€Bulk Streamâ”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                         â”‚                          â”‚
  â”‚                         â”‚                          â”œâ”€â”
  â”‚                         â”‚                          â”‚ â”‚ USB transfer
  â”‚                         â”‚                          â”‚ â”‚ (blocking)
  â”‚                         â”‚                          â—„â”€â”˜
  â”‚                         â”‚                          â”‚
  â”‚  8. TransferComplete    â”‚                          â”‚
  â”‚     (success)           â”‚                          â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€â”€Bulk Streamâ”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                         â”‚                          â”‚
  â”‚                         â”‚                          â”‚
  â”‚  9. DetachDeviceRequest â”‚                          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€QUIC Streamâ”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                         â”‚                          â”‚
  â”‚                         â”‚                          â”œâ”€â”
  â”‚                         â”‚                          â”‚ â”‚ Close device
  â”‚                         â”‚                          â—„â”€â”˜
  â”‚                         â”‚                          â”‚
  â”‚ 10. DetachDeviceResponseâ”‚                          â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€QUIC Streamâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                         â”‚                          â”‚
```

---

## Device Lifecycle State Machine

```
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚             â”‚
                     â”‚ DISCONNECTEDâ”‚
                     â”‚             â”‚
                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                  (physical device plugged in)
                            â”‚
                            â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”Œâ”€â”€â”€â”€â”€â”€â”¤             â”‚
              â”‚      â”‚ DISCOVERED  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚      â”‚             â”‚               â”‚
              â”‚      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜               â”‚
              â”‚             â”‚                      â”‚
              â”‚   (client AttachDevice)            â”‚
  (ListDevices)             â”‚                (grace period
   request)                 â–¼                 expires: 30s)
              â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
              â”‚      â”‚             â”‚               â”‚
              â””â”€â”€â”€â”€â”€â–ºâ”‚  ATTACHED   â”‚               â”‚
                     â”‚             â”‚               â”‚
                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜               â”‚
                            â”‚                      â”‚
                 (USB transfers active)            â”‚
                            â”‚                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚                   â”‚                   â”‚  â”‚
        â”‚          (client DetachDevice)        â”‚  â”‚
        â”‚                   â”‚           (device â”‚  â”‚
    (device           â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”   unplugged  â”‚
   unplugged)         â”‚            â”‚   OR client  â”‚
        â”‚             â”‚  DETACHED  â”‚   disconnect)â”‚
        â”‚             â”‚            â”‚      â”‚       â”‚
        â”‚             â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â”‚       â”‚
        â”‚                   â”‚             â”‚       â”‚
        â”‚       (device still present,    â”‚       â”‚
        â”‚        keep state for reattach) â”‚       â”‚
        â”‚                   â”‚             â”‚       â”‚
        â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚             â”‚
  â”‚   REMOVED   â”‚
  â”‚             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ (cleanup complete)
        â”‚
        â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚             â”‚
  â”‚DISCONNECTED â”‚
  â”‚             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## QUIC Stream Multiplexing

```
CLIENT â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º SERVER
       â”‚                                          â”‚
       â”‚  QUIC Connection (TLS 1.3 encrypted)    â”‚
       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
       â”‚  â”‚                                    â”‚ â”‚
       â”‚  â”‚  Stream 0: Control Transfers       â”‚ â”‚
       â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
       â”‚  â”‚  â”‚ GET_DESCRIPTOR               â”‚  â”‚ â”‚
       â”‚  â”‚  â”‚ SET_CONFIGURATION            â”‚  â”‚ â”‚
       â”‚  â”‚  â”‚ SET_INTERFACE                â”‚  â”‚ â”‚
       â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
       â”‚  â”‚                                    â”‚ â”‚
       â”‚  â”‚  Stream 1: Interrupt Transfers     â”‚ â”‚
       â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
       â”‚  â”‚  â”‚ Keyboard events              â”‚  â”‚ â”‚
       â”‚  â”‚  â”‚ Mouse movements              â”‚  â”‚ â”‚
       â”‚  â”‚  â”‚ HID reports                  â”‚  â”‚ â”‚
       â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
       â”‚  â”‚                                    â”‚ â”‚
       â”‚  â”‚  Stream 2: Bulk Transfers          â”‚ â”‚
       â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
       â”‚  â”‚  â”‚ Storage read/write           â”‚  â”‚ â”‚
       â”‚  â”‚  â”‚ Network packets              â”‚  â”‚ â”‚
       â”‚  â”‚  â”‚ Printer data                 â”‚  â”‚ â”‚
       â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
       â”‚  â”‚                                    â”‚ â”‚
       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
       â”‚                                          â”‚
       â”‚  Benefits:                               â”‚
       â”‚  - No head-of-line blocking between     â”‚
       â”‚    transfer types                        â”‚
       â”‚  - Large bulk transfer doesn't delay     â”‚
       â”‚    control transfer                      â”‚
       â”‚  - Matches USB endpoint semantics        â”‚
       â”‚                                          â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Security Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SECURITY LAYERS                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚  Layer 1: Network Authentication & Encryption              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Iroh P2P Network (QUIC/TLS 1.3)                      â”‚ â”‚
â”‚  â”‚ - Ed25519 NodeId (32 bytes) = cryptographic identity â”‚ â”‚
â”‚  â”‚ - End-to-end encryption (AES-GCM)                    â”‚ â”‚
â”‚  â”‚ - Perfect forward secrecy                            â”‚ â”‚
â”‚  â”‚ - No PKI/CA needed (self-sovereign identity)         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                â”‚
â”‚                           â–¼                                â”‚
â”‚  Layer 2: Authorization (NodeId Allowlists)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Server Config:                                       â”‚ â”‚
â”‚  â”‚   client_allowlist = [                               â”‚ â”‚
â”‚  â”‚     "ed25519:abc123...",  # Laptop                   â”‚ â”‚
â”‚  â”‚     "ed25519:def456...",  # Desktop                  â”‚ â”‚
â”‚  â”‚   ]                                                  â”‚ â”‚
â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚ Client Config:                                       â”‚ â”‚
â”‚  â”‚   server_allowlist = [                               â”‚ â”‚
â”‚  â”‚     "ed25519:789ghi...",  # Raspberry Pi             â”‚ â”‚
â”‚  â”‚   ]                                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                â”‚
â”‚                           â–¼                                â”‚
â”‚  Layer 3: Device-Level Authorization                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Per-Device Sharing Rules:                            â”‚ â”‚
â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚ [[devices]]                                          â”‚ â”‚
â”‚  â”‚ vendor_id = 0x1234                                   â”‚ â”‚
â”‚  â”‚ product_id = 0x5678                                  â”‚ â”‚
â”‚  â”‚ name = "Yubikey"                                     â”‚ â”‚
â”‚  â”‚ shared = true                                        â”‚ â”‚
â”‚  â”‚ require_pin = true                                   â”‚ â”‚
â”‚  â”‚ pin_hash = "sha256:..."                              â”‚ â”‚
â”‚  â”‚                                                      â”‚ â”‚
â”‚  â”‚ [[devices]]                                          â”‚ â”‚
â”‚  â”‚ vendor_id = 0x0951                                   â”‚ â”‚
â”‚  â”‚ product_id = 0x1666                                  â”‚ â”‚
â”‚  â”‚ name = "USB Storage"                                 â”‚ â”‚
â”‚  â”‚ shared = true                                        â”‚ â”‚
â”‚  â”‚ require_pin = false                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                â”‚
â”‚                           â–¼                                â”‚
â”‚  Layer 4: Runtime Access Control                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Server TUI Controls:                                 â”‚ â”‚
â”‚  â”‚ - Operator can enable/disable sharing per device     â”‚ â”‚
â”‚  â”‚ - Active sessions displayed with client NodeId       â”‚ â”‚
â”‚  â”‚ - Forcibly disconnect clients                        â”‚ â”‚
â”‚  â”‚ - Audit log of all USB access                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                â”‚
â”‚                           â–¼                                â”‚
â”‚  Layer 5: Rate Limiting & DoS Prevention                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ - Max 1000 transfers/second per client               â”‚ â”‚
â”‚  â”‚ - Max 10 concurrent devices per client               â”‚ â”‚
â”‚  â”‚ - Bounded channel backpressure (capacity: 256)       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Deployment Architecture (Raspberry Pi)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RASPBERRY PI 4                            â”‚
â”‚                  (Debian 12, aarch64)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Systemd Service                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ /etc/systemd/system/rust-p2p-usb-server.service       â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚ [Unit]                                                 â”‚ â”‚
â”‚  â”‚ Description=rust-p2p-usb Server                        â”‚ â”‚
â”‚  â”‚ After=network-online.target                            â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚ [Service]                                              â”‚ â”‚
â”‚  â”‚ Type=notify                                            â”‚ â”‚
â”‚  â”‚ User=usb-proxy                                         â”‚ â”‚
â”‚  â”‚ ExecStart=/usr/local/bin/rust-p2p-usb-server          â”‚ â”‚
â”‚  â”‚ Restart=always                                         â”‚ â”‚
â”‚  â”‚ RestartSec=5                                           â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚ [Install]                                              â”‚ â”‚
â”‚  â”‚ WantedBy=multi-user.target                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â”‚                                 â”‚
â”‚                            â–¼                                 â”‚
â”‚  Binary                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ /usr/local/bin/rust-p2p-usb-server                     â”‚ â”‚
â”‚  â”‚ (cross-compiled with: cargo build --target             â”‚ â”‚
â”‚  â”‚  aarch64-unknown-linux-gnu --release)                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â”‚                                 â”‚
â”‚                            â–¼                                 â”‚
â”‚  Configuration                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ /etc/rust-p2p-usb/server-config.toml                   â”‚ â”‚
â”‚  â”‚ - Client allowlist                                     â”‚ â”‚
â”‚  â”‚ - Device sharing rules                                 â”‚ â”‚
â”‚  â”‚ - Network settings (relay servers)                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â”‚                                 â”‚
â”‚                            â–¼                                 â”‚
â”‚  USB Permissions (udev)                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ /etc/udev/rules.d/99-rust-p2p-usb.rules                â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚ SUBSYSTEM=="usb", MODE="0660", GROUP="usb-proxy"       â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚ (usb-proxy user in usb-proxy group)                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â”‚                                 â”‚
â”‚                            â–¼                                 â”‚
â”‚  Logging                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ journalctl -u rust-p2p-usb-server -f                   â”‚ â”‚
â”‚  â”‚ (structured logging with tracing crate)                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  USB Devices                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ /dev/bus/usb/001/002  (keyboard)                       â”‚ â”‚
â”‚  â”‚ /dev/bus/usb/001/003  (mouse)                          â”‚ â”‚
â”‚  â”‚ /dev/bus/usb/002/001  (storage)                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Performance Bottleneck Analysis

```
USB Transfer Latency Breakdown (Target: 5-20ms)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Component                  â”‚ Latency    â”‚ % of Total    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. USB Host (kernel)       â”‚ ~1ms       â”‚ 6%            â”‚
â”‚ 2. rusb (libusb overhead)  â”‚ ~0.1ms     â”‚ 0.6%          â”‚
â”‚ 3. Channel send            â”‚ ~0.01ms    â”‚ 0.06%         â”‚
â”‚ 4. Postcard serialize      â”‚ ~0.05ms    â”‚ 0.3%          â”‚
â”‚ 5. QUIC stream write       â”‚ ~0.05ms    â”‚ 0.3%          â”‚
â”‚ 6. Network RTT             â”‚ ~1-50ms    â”‚ 6-294%        â”‚ â—„â”€ BOTTLENECK
â”‚ 7. QUIC stream read        â”‚ ~0.05ms    â”‚ 0.3%          â”‚
â”‚ 8. Postcard deserialize    â”‚ ~0.05ms    â”‚ 0.3%          â”‚
â”‚ 9. Channel recv            â”‚ ~0.01ms    â”‚ 0.06%         â”‚
â”‚ 10. USB Device (kernel)    â”‚ ~1ms       â”‚ 6%            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TOTAL (LAN, 1ms network)   â”‚ ~3.4ms     â”‚ 100%          â”‚ âœ“ Within target
â”‚ TOTAL (Internet, 15ms net) â”‚ ~17.4ms    â”‚ 100%          â”‚ âœ“ Within target
â”‚ TOTAL (Poor, 50ms network) â”‚ ~52.4ms    â”‚ 100%          â”‚ âœ— Exceeds target
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Observation: Network latency dominates (94% of total in poor case).
             Software overhead is <0.5ms (excellent).
             Architecture meets targets for good networks.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

USB Transfer Throughput Breakdown (Target: 38-43 MB/s)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Theoretical USB 2.0        â”‚ 480 Mbps = 60 MB/s         â”‚
â”‚ USB Protocol Overhead      â”‚ ~20% â†’ 48 MB/s achievable  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ rusb/libusb overhead       â”‚ ~5% â†’ 45.6 MB/s            â”‚
â”‚ Postcard serialization     â”‚ ~0.7% â†’ 45.3 MB/s          â”‚
â”‚ QUIC stream efficiency     â”‚ ~5% â†’ 43 MB/s              â”‚
â”‚ Network bandwidth          â”‚ Variable (bottleneck)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TOTAL (Gigabit LAN)        â”‚ ~43 MB/s                   â”‚ âœ“ 90% of USB 2.0
â”‚ TOTAL (100 Mbps)           â”‚ ~12 MB/s                   â”‚ âœ— Limited by network
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Observation: On good networks (Gigabit LAN), architecture achieves
             90% of USB 2.0 theoretical max. Excellent efficiency.
```

---

## Crate Dependency Graph

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  WORKSPACE DEPENDENCIES                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ server  â”‚                    â”‚ client  â”‚
      â”‚ binary  â”‚                    â”‚ binary  â”‚
      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
           â”‚                              â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
           â”‚          â”‚                  â”‚
           â–¼          â–¼                  â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚protocol â”‚ â”‚ common  â”‚      â”‚protocol â”‚
      â”‚  lib    â”‚ â”‚   lib   â”‚      â”‚  lib    â”‚
      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
           â”‚           â”‚                â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–¼           â–¼           â–¼
       â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”
       â”‚rusb â”‚    â”‚iroh â”‚    â”‚tokioâ”‚
       â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜
           â”‚           â”‚           â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ System Libs    â”‚
              â”‚ libusb-1.0     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Key Dependencies by Crate:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

server binary:
  - protocol (internal)
  - common (internal)
  - rusb (USB access)
  - iroh (P2P networking)
  - tokio (async runtime)
  - ratatui (TUI)
  - anyhow (error handling)

client binary:
  - protocol (internal)
  - common (internal)
  - rusb (virtual USB)
  - iroh (P2P networking)
  - tokio (async runtime)
  - ratatui (TUI)
  - anyhow (error handling)
  - nix (Linux usbfs ioctl)

protocol library:
  - serde (serialization)
  - postcard (codec)
  - bytes (zero-copy buffers)
  - thiserror (typed errors)

common library:
  - iroh (re-export types)
  - async-channel (bridge)
  - tokio (minimal)
  - thiserror (typed errors)
```

---

**END OF DIAGRAMS**
